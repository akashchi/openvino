name: JS API
on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'src/bindings/js/**'
      - '.github/workflows/js_api.yml'
  push:
    paths:
      - 'src/bindings/js/**'
      - '.github/workflows/js_api.yml'
    branches:
      - master
      - 'releases/**'

concurrency:
  # github.ref is not unique in post-commit
  group: ${{ github.event_name == 'push' && github.run_id || github.ref }}-js-api
  cancel-in-progress: true

jobs:
  JS_API:
    name: Configure and Test JS API Bindings
    strategy:
      max-parallel: 3
      fail-fast: false
      matrix:
        include:
          - machine: 'ubuntu-22.04'
            shell: 'bash'
          - machine: 'windows-2022'
            shell: 'pwsh'
          - machine: 'macos-12'
            shell: 'bash'
    defaults:
      run:
        shell: ${{ matrix.shell }}
    runs-on: ${{ matrix.machine }}
    env:
      OPENVINO_REPO: "${{ github.workspace }}/openvino"
      JS_BINDINGS_DIR: "${{ github.workspace }}/openvino/src/bindings/js"
    steps:
      - name: Clone OpenVINO
        uses: actions/checkout@v4
        with:
          path: 'openvino'

      #
      # Dependencies
      #

      - name: Install dependencies
        if: ${{ contains(matrix.machine, 'ubuntu') }}
        run: sudo -E ${{ env.OPENVINO_REPO }}/scripts/install_dependencies/install_openvino_dependencies.sh -y

      #
      # Configure JS API
      #

      - name: Configure JS API
        working-directory: ${{ env.JS_BINDINGS_DIR }}/node
        run: npm i

      - name: List bin files
        if: ${{ contains(matrix.machine, 'windows') }}
        shell: cmd
        run: dir ${{ env.JS_BINDINGS_DIR }} /s

      #
      # Tests
      #

      - name: Run tests (Unix)
        if: ${{ !contains(matrix.machine, 'windows') }}
        working-directory: ${{ env.JS_BINDINGS_DIR }}/node
        run: |
          export LD_LIBRARY_PATH=${{ env.JS_BINDINGS_DIR }}/node/ov_runtime/runtime/lib/intel64/:$LD_LIBRARY_PATH
          npm test

      - name: Run tests (Windows)
        if: ${{ contains(matrix.machine, 'windows') }}
        working-directory: ${{ env.JS_BINDINGS_DIR }}/node
        run: |
          $env:Path = '${{ env.JS_BINDINGS_DIR }}/node/ov_runtime/runtime/lib/intel64/;' + $env:Path
          npm test

      - name: Run tests (Windows) CMD
        shell: cmd
        if: ${{ contains(matrix.machine, 'windows') }}
        working-directory: ${{ env.JS_BINDINGS_DIR }}/node
        run: |
          set path=%path%;${{ env.JS_BINDINGS_DIR }}\node\ov_runtime\runtime\lib\intel64
          npm test
